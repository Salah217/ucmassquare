{% extends "portal/layout.html" %}
{% load static %}
{% block title %}Dashboard | UCMAS{% endblock %}

{% block content %}

<!-- Floating banner -->
<img src="{% static 'brand/ucmas_dashboard.png' %}" alt="UCMAS" class="dashboard-banner"/>

<div class="page-header d-print-none mb-4">
  <div class="row align-items-center g-2">
    <div class="col">
      <h2 class="page-title mb-1">Dashboard</h2>
      <div class="text-muted mt-1">
        Welcome, {{ request.user.username }}{% if org_name %} · {{ org_name }}{% endif %}
      </div>
    </div>
  </div>
</div>

<style>
/* ===== Banner ===== */
.dashboard-banner{
  position: fixed;
  top: 88px;
  right: 18px;
  width: 170px;
  max-width: 19vw;
  z-index: 2;
  opacity: .40;           /* make it softer */
  pointer-events: none;
  filter: drop-shadow(0 10px 18px rgba(0,0,0,.10));
}
@media (max-width: 992px){
  .dashboard-banner{
    position: static;
    display: block;
    margin: 0 0 12px auto;
    width: 260px;
    max-width: 90%;
    opacity: 1;
  }
}
@media (min-width: 992px){
  .dashboard-top{ padding-right: 220px; }
}

/* ===== Modules ===== */
.module-card{
  border-radius: 14px;
  min-height: 160px;
  border: 1px solid rgba(0,0,0,.06);
}
.module-card .card-body{ padding: 22px; }
.module-pill{
  padding:.28rem .65rem;
  border-radius:999px;
  font-size:.75rem;
  font-weight:700;
  background:rgba(255,255,255,.65);
}
.module-green{background:rgba(47,179,68,.18);}
.module-yellow{background:rgba(245,159,0,.18);}
.module-blue{background:rgba(32,107,196,.16);}

/* ===== KPI GRID (fixed widths 2/2/4/4) ===== */
.dashboard-kpi-grid{
  display: grid;
  grid-template-columns: 1fr 1fr 2fr 2fr; /* 2 / 2 / 4 / 4 */
  gap: 16px;
  align-items: stretch;
  width: 100%;
}
@media (max-width: 1200px){
  .dashboard-kpi-grid{ grid-template-columns: 1fr 1fr; }
}
@media (max-width: 768px){
  .dashboard-kpi-grid{ grid-template-columns: 1fr; }
}

/* ===== 3D KPI Tiles ===== */
.kpi-3d-box{
  border: 1px solid rgba(0,0,0,.06);
  border-radius: 14px;
  background: #fff;
  padding: 16px;
  height: 100%;
  text-decoration: none;
}
.kpi-3d{
  height: 150px;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
}
.kpi-3d-label{
  font-size:.75rem;
  letter-spacing:.12em;
  text-transform:uppercase;
  color:#6c7a90;
}
.kpi-3d-number{
  font-size:3.2rem;
  font-weight:900;
  color:#206bc4;
  line-height: 1;
  text-shadow:
    0 1px 0 #c7daf7,
    0 2px 0 #b6cdf2,
    0 3px 0 #a5c0ee,
    0 6px 12px rgba(32,107,196,.35);
}
.kpi-3d-hint{
  margin-top: 8px;
  font-size: .9rem;
  color: #6c7a90;
  text-align:center;
}

/* ===== KPI Cards ===== */
.kpi-card{
  border-radius:14px;
  border:1px solid rgba(0,0,0,.06);
  background:#fff;
  height: 100%;
}
.kpi-card .card-body{
  height:100%;
  display:flex;
  flex-direction:column;
  padding: 18px;
}
.kpi-card .h1{text-align:center;}
.kpi-card .subheader{text-align:center;}
.kpi-card .text-muted.mt-2{margin-top:auto!important;}

/* ===== One-line badges ===== */
.kpi-badges{
  display:flex;
  gap:.5rem;
  flex-wrap:nowrap;
  overflow-x:auto;
  -webkit-overflow-scrolling: touch;
}
.kpi-badges .badge{ white-space:nowrap; }
</style>

<div class="row row-deck row-cards">
<div class="col-12 dashboard-top">

  <!-- ✅ ROW 1: MODULES ONLY -->
  <div class="row g-3 dashboard-modules-row">
    <div class="col-12 col-lg-4">
      <a href="{% url 'portal_student_add' %}" class="card module-card module-green text-decoration-none h-100">
        <div class="card-body">
          <span class="module-pill">MODULE</span>
          <h3 class="mt-3 mb-1">Register New Student</h3>
          <div class="text-muted">Add a student to your database</div>
        </div>
      </a>
    </div>

    <div class="col-12 col-lg-4">
      <a href="{% url 'portal_course_register' %}" class="card module-card module-yellow text-decoration-none h-100">
        <div class="card-body">
          <span class="module-pill">MODULE</span>
          <h3 class="mt-3 mb-1">Apply for a Course</h3>
          <div class="text-muted">Enroll eligible students</div>
        </div>
      </a>
    </div>

    <div class="col-12 col-lg-4">
      <a href="{% url 'portal_competition_register' %}" class="card module-card module-blue text-decoration-none h-100">
        <div class="card-body">
          <span class="module-pill">MODULE</span>
          <h3 class="mt-3 mb-1">Register Competition</h3>
          <div class="text-muted">Add students to competitions</div>
        </div>
      </a>
    </div>
  </div>

  <!-- ✅ ROW 2: KPI ONLY (3D + status cards) -->
  <div class="dashboard-kpi-grid dashboard-kpi-row">

    <a href="{% url 'portal_student_list' %}" class="kpi-3d-box kpi-3d text-decoration-none">
      <div class="kpi-3d-label">Student No</div>
      <div class="kpi-3d-number">{{ total_students }}</div>
      <div class="kpi-3d-hint">Total students</div>
    </a>

    <a href="{% url 'portal_competition_register' %}" class="kpi-3d-box kpi-3d text-decoration-none">
      <div class="kpi-3d-label">Competition</div>
      <div class="kpi-3d-number">{{ open_events|length }}</div>
      <div class="kpi-3d-hint">Open events</div>
    </a>

    <a href="{% if is_manager %}{% url 'portal_course_submission_inbox' %}{% else %}{% url 'portal_course_enrollment_list' %}{% endif %}"
       class="card kpi-card text-decoration-none">
      <div class="card-body">
        <div class="subheader">{% if is_manager %}Submission Inbox{% else %}Registration Status{% endif %}</div>
        <div class="h1 mb-2">{{ course_total|default:"—" }}</div>

        <div class="kpi-badges">
          <span class="badge bg-blue-lt">Draft: {{ course_draft_count|default:"0" }}</span>
          <span class="badge bg-yellow-lt">Submitted: {{ course_submitted_count|default:"0" }}</span>
          <span class="badge bg-green-lt">Accepted: {{ course_accepted_count|default:"0" }}</span>
        </div>

        <div class="text-muted mt-2">
          {% if is_manager %}Submit draft applications to admin{% else %}Track enrollments{% endif %}
        </div>
      </div>
    </a>

    <a href="{% url 'portal_competition_register' %}" class="card kpi-card text-decoration-none">
      <div class="card-body">
        <div class="subheader">Competition Registrations</div>
        <div class="h1 mb-2">—</div>

        <div class="kpi-badges">
          <span class="badge bg-blue-lt">Draft: {{ comp_draft_count|default:"0" }}</span>
          <span class="badge bg-yellow-lt">Unpaid: {{ comp_unpaid_count|default:"0" }}</span>
          <span class="badge bg-green-lt">Paid: {{ comp_paid_count|default:"0" }}</span>
        </div>

        <div class="text-muted mt-2">Payments & approvals</div>
      </div>
    </a>

  </div>

</div>

  
  <!-- ✅ END TOP AREA -->
  <!-- Recent Students -->
  <div class="col-12 mt-3">
    <div class="card">
      <div class="card-header"><h3 class="card-title">Recent Students</h3></div>
      <div class="table-responsive">
        <table class="table table-vcenter card-table">
          <tbody>
            {% for s in recent_students %}
              <tr>
                <td class="text-muted">{{ s.sa_registration_no }}</td>
                <td class="fw-semibold">{{ s.first_name_en }} {{ s.last_name_en }}</td>
                <td><span class="badge bg-blue-lt">Level {{ s.current_level }}</span></td>
                <td class="text-end">
                  <a href="{% url 'portal_student_edit' s.pk %}" class="btn btn-sm btn-outline-primary">Edit</a>
                </td>
              </tr>
            {% empty %}
              <tr><td colspan="4" class="text-center text-muted py-4">No students yet</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Open Events -->
  <div class="col-12 mt-3">
    <div class="card">
      <div class="card-header"><h3 class="card-title">Current Open Events</h3></div>
      <div class="table-responsive">
        <table class="table table-vcenter">
          <tbody>
            {% for ev in open_events %}
              <tr>
                <td><span class="badge bg-blue-lt">{{ ev.code }}</span></td>
                <td class="fw-semibold">{{ ev.name }}</td>
                <td>{{ ev.city|default:"-" }}</td>
                <td>{{ ev.deadline|default:"-" }}</td>
                <td><span class="badge bg-green-lt">OPEN</span></td>
              </tr>
            {% empty %}
              <tr><td colspan="5" class="text-center text-muted py-3">No OPEN events currently.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

</div>
{% endblock %}
