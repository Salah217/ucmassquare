{% extends "portal/layout.html" %}

{% block title %}Dashboard | UCMAS{% endblock %}

{% block content %}
<div class="page-header d-print-none mb-4">
  <div class="row align-items-center g-2">
    <div class="col">
      <h2 class="page-title mb-1">Dashboard</h2>
      <div class="text-muted mt-1">
        Welcome, {{ request.user.username }}{% if org_name %} · {{ org_name }}{% endif %}
      </div>
    </div>
    <div class="col-auto ms-auto">
      <a href="{% url 'portal_student_add' %}" class="btn btn-primary">
        Add Student
      </a>
    </div>
  </div>
</div>

<div class="row row-deck row-cards">

  {# ✅ 3 Main Modules (Action cards) #}
  <div class="col-12">
    <div class="row g-3">

      <div class="col-md-4">
        <a href="{% url 'portal_student_add' %}" class="card card-link text-decoration-none">
          <div class="card-body">
            <div class="subheader">Module</div>
            <div class="h3 mb-1">Register New Student</div>
            <div class="text-muted">Add a student to your school database.</div>
          </div>
        </a>
      </div>

      <div class="col-md-4">
        <a href="{% url 'portal_course_register' %}" class="card card-link text-decoration-none">
          <div class="card-body">
            <div class="subheader">Module</div>
            <div class="h3 mb-1">Register in a Course</div>
            <div class="text-muted">Select students and enroll them in a course.</div>
          </div>
        </a>
      </div>

    <div class="col-md-4">
  <a href="{% url 'portal_competition_register' %}" class="card card-link text-decoration-none">
    <div class="card-body">
      <div class="subheader">Module</div>
      <div class="h3 mb-1">Register in a Competition</div>
      <div class="text-muted">
        Select students and add them to a competition.
      </div>

      {# Manager-only next step button (enable later when submit/payment url exists) #}
      {# 
      <div class="mt-3">
        <a class="btn btn-danger w-100" href="#">
          Submit & Payment
        </a>
      </div>
      #}

    </div>
  </a>
</div>


    </div>
  </div>

  {# ✅ KPIs #}
  <div class="col-sm-6 col-lg-3">
    <a href="{% url 'portal_student_list' %}" class="card text-decoration-none">
      <div class="card-body">
        <div class="subheader">Total Students</div>
        <div class="h1 mb-0">{{ total_students }}</div>
        <div class="text-muted mt-2">Students in your school database</div>
      </div>
    </a>
  </div>

  <div class="col-sm-6 col-lg-3">
    <a href="{% url 'portal_competition_register' %}" class="card text-decoration-none">
      <div class="card-body">
        <div class="subheader">Open Competitions</div>
        <div class="h1 mb-0">{{ open_events|length }}</div>
        <div class="text-muted mt-2">Available competitions</div>
      </div>
    </a>
  </div>

  <div class="col-sm-6 col-lg-3">
    <a href="{% url 'portal_course_register' %}" class="card text-decoration-none">
      <div class="card-body">
        <div class="subheader">Courses</div>
        <div class="h1 mb-0">—</div>
        <div class="text-muted mt-2">Course registrations</div>
      </div>
    </a>
  </div>

  <div class="col-sm-6 col-lg-3">
    <a href="{% url 'portal_competition_register' %}" class="card text-decoration-none">
      <div class="card-body">
        <div class="subheader">Competition Registrations</div>
        <div class="h1 mb-0">—</div>
        <div class="text-muted mt-2">Payments & approvals</div>
      </div>
    </a>
  </div>

  {# ✅ Recent Students #}
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Recent Students</h3>
        <div class="card-actions">
          <a href="{% url 'portal_student_list' %}" class="btn btn-outline-primary btn-sm">
            View all
          </a>
        </div>
      </div>

      <div class="table-responsive">
        <table class="table table-vcenter card-table">
          <thead>
            <tr>
              <th>Registration No</th>
              <th>Student</th>
              <th>Level</th>
              <th class="w-1"></th>
            </tr>
          </thead>
          <tbody>
            {% for s in recent_students %}
              <tr>
                <td class="text-muted">{{ s.sa_registration_no|default:"—" }}</td>
                <td class="fw-semibold">{{ s.first_name_en }} {{ s.last_name_en }}</td>
                <td>
                  {% if s.current_level %}
                    <span class="badge bg-blue-lt">Level {{ s.current_level }}</span>
                  {% else %}
                    <span class="text-muted">—</span>
                  {% endif %}
                </td>
                <td class="text-end">
                  <a class="btn btn-sm btn-outline-primary" href="{% url 'portal_student_edit' s.pk %}">
                    Edit
                  </a>
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="4" class="text-center text-muted py-4">
                  No students yet.
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  {# ✅ Current Open Events (info table) #}
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Current Open Events</h3>
      </div>
      <div class="card-body">
        {% if open_events %}
          <div class="table-responsive">
            <table class="table table-vcenter">
              <thead>
                <tr>
                  <th>Code</th>
                  <th>Name</th>
                  <th>City</th>
                  <th>Deadline</th>
                  <th>Fee</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                {% for ev in open_events %}
                <tr>
                  <td><span class="badge bg-blue-lt">{{ ev.code }}</span></td>
                  <td class="fw-semibold">{{ ev.name }}</td>
                  <td>{{ ev.city|default:"-" }}</td>
                  <td>{{ ev.deadline|default:"-" }}</td>

                  {# (1) Currency + 2 decimals #}
                  <td class="text-muted">
                    {{ ev.fee_per_student|floatformat:2 }} <small class="text-muted">SAR</small>
                  </td>

                  <td><span class="badge bg-green-lt">OPEN</span></td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="text-muted">No OPEN events currently.</div>
        {% endif %}
      </div>
    </div>
  </div>

</div>
{% endblock %}
