{% extends "portal/layout.html" %}
{% load static %}
{% block title %}Dashboard | UCMAS{% endblock %}

{% block content %}

<style>
/* =========================================================
   DASHBOARD LAYOUT (Left content + Right banner column)
   ========================================================= */
.dashboard-top{
  display: grid;
  grid-template-columns: minmax(0, 3.2fr) minmax(260px, 0.8fr); /* ✅ left bigger, right smaller */  
  gap: 18px;
  align-items: start;
  width: 100%;
}

/* Left area: modules row + KPI row */
.dashboard-left{
  display: grid;
  grid-template-rows: auto auto;
  gap: 18px;
  min-width: 0;
}

/* Right area: banner floating top */
.dashboard-right{
  min-width: 0;
  position: relative;
}

/* ✅ Banner: smaller by half + floats top-right of its column */
.dashboard-banner{
  width: 260px;              /* ✅ half size */
  max-width: 260px;        /* safety */
  height: auto;
  opacity: .95;
  filter: drop-shadow(0 10px 18px rgba(0,0,0,.12));
  pointer-events: none;
  border-radius: 14px;
  position: sticky;        /* ✅ floats while scrolling within column */
  top: 0;
  margin-left: auto;       /* push right */
  display: block;
  margin-top: 4px;
}

/* Row 1: modules = 3 equal columns */
.modules-row{
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 16px;
  min-width: 0;
}

/* Row 2: KPI layout = 4 columns (same row)
   - Student small
   - Competition small
   - Registration Status (wide)
   - Competition Registrations (wide)
*/
.kpi-row{
  display: grid;
  grid-template-columns: .75fr .75fr 1.25fr 1.25fr; /* ✅ make 3D smaller, KPI bigger */
  gap: 16px;
  min-width: 0;
}

/* 3D number tiles (smaller) */
.kpi-3d-tile{
  border: 1px solid rgba(0,0,0,.06);
  border-radius: 14px;
  background: #fff;
  padding: 12px;
  height: 140px;                 /* ✅ smaller */
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  text-decoration:none;
  min-width: 0;
}
.kpi-3d-label{
  font-size:.70rem;
  letter-spacing:.12em;
  text-transform:uppercase;
  color:#6c7a90;
}
.kpi-3d-number{
  font-size:2.6rem;              /* ✅ smaller number */
  font-weight:900;
  color:#7fb5ff;
  line-height: 1;
  margin-top: 6px;
  text-shadow:
    0 4px 12px rgba(32,107,196,.16);
}
.kpi-3d-hint{
  margin-top: 6px;
  font-size: .85rem;
  color: #6c7a90;
  text-align:center;
}

/* KPI cards (same row) */
.kpi-3d-tile,
.kpi-card{
  border-radius:14px;
  border:1px solid rgba(0,0,0,.06);
  background:#fff;
  height: 140px;                 /* ✅ align with 3D tiles */
  min-width: 0;
}
.kpi-card .card-body{
  height:100%;
  display:flex;
  flex-direction:column;
  padding: 14px;
  min-width: 0;
}
.kpi-card .subheader{
  text-align:center;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  margin-bottom: 8px;
}
.kpi-card .h1{
  text-align:center;
  margin-bottom: 8px;
  font-size: 1.6rem;            /* smaller headline */
}

/* One-line badges */
.kpi-badges{
  display:flex;
  gap:.5rem;
  flex-wrap: nowrap;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}
.kpi-badges .badge{ white-space: nowrap; }

/* Modules */
.module-card{
  border-radius: 14px;
  min-height: 170px;
  border: 1px solid rgba(0,0,0,.06);
}
.module-card .card-body{ padding: 22px; }
.module-pill{
  display:inline-block;
  padding:.28rem .65rem;
  border-radius:999px;
  font-size:.75rem;
  font-weight:700;
  background:rgba(255,255,255,.65);
}
.module-green{background:rgba(47,179,68,.18);}
.module-yellow{background:rgba(245,159,0,.18);}
.module-blue{background:rgba(32,107,196,.16);}

/* Responsive */
@media (max-width: 1200px){
  .dashboard-top{ grid-template-columns: 1fr; }
  .modules-row{ grid-template-columns: 1fr; }
  .kpi-row{ grid-template-columns: 1fr; }
  .kpi-card, .kpi-3d-tile{ height: auto; }
  .dashboard-banner{ position: static; width: 60%; max-width: 220px; margin: 0 auto 10px; }
}
</style>
<div class="page-header d-print-none mb-4">
  <div class="row align-items-center g-2">
    <div class="col">
      <h2 class="page-title mb-1">Dashboard</h2>
      <div class="text-muted mt-1">
        Welcome, {{ request.user.username }}{% if org_name %} · {{ org_name }}{% endif %}
      </div>
    </div>
  </div>
</div>

<!-- ✅ TOP AREA: 2 columns (left content + right banner) -->
<div class="dashboard-top">

  <!-- LEFT COLUMN -->
  <div class="dashboard-left">

    <!-- ROW 1: MODULES -->
    <div class="modules-row">
      <a href="{% url 'portal_student_add' %}" class="card module-card module-green text-decoration-none">
        <div class="card-body">
          <span class="module-pill">MODULE</span>
          <h3 class="mt-3 mb-1">Register New Student</h3>
          <div class="text-muted">Add a student to your database</div>
        </div>
      </a>

      <a href="{% url 'portal_course_register' %}" class="card module-card module-yellow text-decoration-none">
        <div class="card-body">
          <span class="module-pill">MODULE</span>
          <h3 class="mt-3 mb-1">Apply for a Course</h3>
          <div class="text-muted">Enroll eligible students</div>
        </div>
      </a>

      <a href="{% url 'portal_competition_register' %}" class="card module-card module-blue text-decoration-none">
        <div class="card-body">
          <span class="module-pill">MODULE</span>
          <h3 class="mt-3 mb-1">Register Competition</h3>
          <div class="text-muted">Add students to competitions</div>
        </div>
      </a>
    </div>

    <!-- ROW 2: KPI (ALL IN ONE ROW) -->
    <div class="kpi-row">

      <a href="{% url 'portal_student_list' %}" class="kpi-3d-tile">
        <div class="kpi-3d-label">Student No</div>
        <div class="kpi-3d-number">{{ total_students }}</div>
        <div class="kpi-3d-hint">Total students</div>
      </a>

      <a href="{% url 'portal_competition_register' %}" class="kpi-3d-tile">
        <div class="kpi-3d-label">Competition</div>
        <div class="kpi-3d-number">{{ open_events|length }}</div>
        <div class="kpi-3d-hint">Open events</div>
      </a>

      <a href="{% if is_manager %}{% url 'portal_course_submission_inbox' %}{% else %}{% url 'portal_course_enrollment_list' %}{% endif %}"
         class="card kpi-card text-decoration-none">
        <div class="card-body">
          <div class="subheader">{% if is_manager %}Submission Inbox{% else %}Registration Status{% endif %}</div>
          <div class="h1">{{ course_total|default:"—" }}</div>
          <div class="kpi-badges">
            <span class="badge bg-blue-lt">Draft: {{ course_draft_count|default:"0" }}</span>
            <span class="badge bg-yellow-lt">Submitted: {{ course_submitted_count|default:"0" }}</span>
            <span class="badge bg-green-lt">Accepted: {{ course_accepted_count|default:"0" }}</span>
          </div>
        </div>
      </a>

      <a href="{% url 'portal_competition_register' %}" class="card kpi-card text-decoration-none">
        <div class="card-body">
          <div class="subheader">Competition Registrations</div>
          <div class="h1">—</div>
          <div class="kpi-badges">
            <span class="badge bg-blue-lt">Draft: {{ comp_draft_count|default:"0" }}</span>
            <span class="badge bg-yellow-lt">Unpaid: {{ comp_unpaid_count|default:"0" }}</span>
            <span class="badge bg-green-lt">Paid: {{ comp_paid_count|default:"0" }}</span>
          </div>
        </div>
      </a>

    </div>

  </div>

  <!-- RIGHT COLUMN (banner floats top) -->
  <div class="dashboard-right">
    <img src="{% static 'brand/ucmas_dashboard.png' %}" alt="UCMAS Banner" class="dashboard-banner">
  </div>

</div>


<!-- ✅ Recent Students -->
<div class="card mt-4">
  <div class="card-header">
    <h3 class="card-title">Recent Students</h3>
  </div>
  <div class="table-responsive">
    <table class="table table-vcenter card-table">
      <tbody>
        {% for s in recent_students %}
          <tr>
            <td class="text-muted">{{ s.sa_registration_no }}</td>
            <td class="fw-semibold">{{ s.first_name_en }} {{ s.last_name_en }}</td>
            <td><span class="badge bg-blue-lt">Level {{ s.current_level }}</span></td>
            <td class="text-end">
              <a href="{% url 'portal_student_edit' s.pk %}" class="btn btn-sm btn-outline-primary">Edit</a>
            </td>
          </tr>
        {% empty %}
          <tr><td colspan="4" class="text-center text-muted py-4">No students yet</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- ✅ Current Open Events -->
<div class="card mt-4">
  <div class="card-header">
    <h3 class="card-title">Current Open Events</h3>
  </div>
  <div class="table-responsive">
    <table class="table table-vcenter">
      <tbody>
        {% for ev in open_events %}
          <tr>
            <td><span class="badge bg-blue-lt">{{ ev.code }}</span></td>
            <td class="fw-semibold">{{ ev.name }}</td>
            <td>{{ ev.city|default:"-" }}</td>
            <td>{{ ev.deadline|default:"-" }}</td>
            <td><span class="badge bg-green-lt">OPEN</span></td>
          </tr>
        {% empty %}
          <tr><td colspan="5" class="text-center text-muted py-3">No OPEN events currently.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

{% endblock %}
